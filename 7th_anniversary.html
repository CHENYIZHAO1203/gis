<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>c&#10084;p 7th anniversary</title>
  <style>
    html, body {
      margin:0; padding:0; width:100%; height:100%;
      background:#000; overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Noto Sans CJK SC","Microsoft YaHei",Arial,sans-serif;
    }
    canvas { display:block; width:100vw; height:100vh; }

    #hint{
      position:fixed; left:50%;
      top:max(14px, env(safe-area-inset-top));
      transform:translateX(-50%);
      padding:8px 12px;
      border:1px solid rgba(255,255,255,0.18);
      border-radius:999px;
      background:rgba(0,0,0,0.28);
      color:rgba(255,255,255,0.78);
      font-size:13px;
      z-index:10;
      pointer-events:none;
      white-space:nowrap;
      opacity:1;
      transition:opacity 600ms ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #hint.hide{ opacity:0; }

    #danmaku{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:20; }
    .dm{
      position:absolute;
      right:-120%;
      white-space:nowrap;
      will-change:transform;
      font-weight:800;
      letter-spacing:0.4px;
      opacity:0.92;
      text-shadow: 0 0 10px rgba(255,255,255,0.25);
      transform: translateX(0);
    }
  </style>
</head>
<body>
  <div id="hint">轻触加烟花 · 双击/长按重来 · 结尾弹幕：c&#10084;p 7th anniversary！</div>
  <canvas id="c"></canvas>
  <div id="danmaku"></div>

<script>
/* ====== RAF polyfill (iOS Safari/旧环境更稳) ====== */
(function() {
  var lastTime = 0;
  var vendors = ['ms','moz','webkit','o'];
  for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
    window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
    window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] ||
                                  window[vendors[x]+'CancelRequestAnimationFrame'];
  }
  if (!window.requestAnimationFrame) {
    window.requestAnimationFrame = function(callback) {
      var currTime = new Date().getTime();
      var timeToCall = Math.max(0, 16 - (currTime - lastTime));
      var id = window.setTimeout(function(){ callback(currTime + timeToCall); }, timeToCall);
      lastTime = currTime + timeToCall;
      return id;
    };
  }
  if (!window.cancelAnimationFrame) {
    window.cancelAnimationFrame = function(id){ clearTimeout(id); };
  }
})();

(function(){
  var canvas = document.getElementById('c');
  var ctx;
  try { ctx = canvas.getContext('2d', { alpha:false }); }
  catch(e){ ctx = canvas.getContext('2d'); }

  var hint = document.getElementById('hint');
  var danmaku = document.getElementById('danmaku');

  function nowMs(){
    if (window.performance && performance.now) return performance.now();
    return new Date().getTime();
  }

  /* ====== 风格：保持“最开始那种干净粒子+拖尾”，但更壮观更满屏 ====== */
  var SHOW_MS = 11000;          // 主烟花时长
  var FINALE_MS = 2200;         // 终章连发时长（之后弹幕）
  var AUTO_RATE = 0.12;         // 平时自动发射密度（更满屏）
  var TRAIL_ALPHA = 0.20;       // 拖尾清屏强度：0.18~0.24（越大越不糊、不泛白）
  var GRAVITY = 0.085;
  var AIR_DRAG = 0.985;
  var SPARK_DRAG = 0.985;

  var DPR_CAP = 2.0;            // 手机性能保险
  var MAX_SPARKS = 4200;        // 防止堆太多导致泛白/卡顿

  // 弹幕内容（关键：这里会显示真正的 ❤ ，不是 "\u2764" 字面量）
  var MESSAGE = 'c\u2764p 7th anniversary！';

  /* ====== 画布适配（处理 iOS 地址栏变化） ====== */
  var W=0, H=0, DPR=1;
  function getVH(){
    if (window.visualViewport && window.visualViewport.height) return window.visualViewport.height;
    return window.innerHeight;
  }
  function resize(){
    DPR = Math.max(1, Math.min(DPR_CAP, window.devicePixelRatio || 1));
    var vw = window.innerWidth;
    var vh = getVH();
    W = Math.floor(vw * DPR);
    H = Math.floor(vh * DPR);
    canvas.width = W;
    canvas.height = H;
    canvas.style.width = vw + 'px';
    canvas.style.height = vh + 'px';
    ctx.fillStyle = 'rgb(0,0,0)';
    ctx.fillRect(0,0,W,H);
  }
  window.addEventListener('resize', resize, {passive:true});
  if (window.visualViewport) window.visualViewport.addEventListener('resize', resize, {passive:true});
  resize();

  /* ====== 工具 ====== */
  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function pick(arr){ return arr[(Math.random()*arr.length)|0]; }

  function randomColor(){
    // 保持原版那种鲜艳但不过曝：提高饱和，亮度适中
    var hues = [0,18,35,55,120,155,190,210,240,280,315,330,350];
    var h = pick(hues) + rand(-8,8);
    var s = rand(82, 100);
    var l = rand(52, 66);
    return {h:h, s:s, l:l};
  }
  function hslCss(c,a){ return 'hsla(' + c.h + ',' + c.s + '%,' + c.l + '%,' + a + ')'; }

  /* ====== 粒子系统（不使用 lighter，不加泛光） ====== */
  var rockets = [];
  var sparks = [];

  function Rocket(x,y,tx,ty,mode){
    this.x=x; this.y=y;
    this.vx = (tx-x) * rand(0.006, 0.012);
    this.vy = (ty-y) * rand(0.006, 0.012) - rand(4.8, 7.6);
    this.life=0;
    this.maxLife = rand(30, 60);
    this.color = randomColor();
    this.mode = mode || 0; // 0普通 1金雨 2心形 3多段
  }
  Rocket.prototype.step = function(){
    this.life++;
    this.x += this.vx;
    this.y += this.vy;
    this.vx *= AIR_DRAG;
    this.vy = this.vy * AIR_DRAG + GRAVITY;

    // 火箭点（稍小，避免泛白）
    drawPoint(this.x, this.y, this.color, 0.95, 1.6);

    // 爆炸条件
    if (this.life >= this.maxLife || this.vy >= -0.18) {
      explode(this.x, this.y, this.color, this.mode);
      return false;
    }
    return true;
  };

  function Spark(x,y,vx,vy,color,size,life,kind){
    this.x=x; this.y=y;
    this.vx=vx; this.vy=vy;
    this.c=color;
    this.size=size;
    this.life=0;
    this.maxLife=life;
    this.twinkle = Math.random() < 0.32;
    this.seed = Math.random()*Math.PI*2;
    this.kind = kind || 0; // 0普通 1金雨
  }
  Spark.prototype.step = function(){
    this.life++;
    this.x += this.vx;
    this.y += this.vy;

    var drag = (this.kind===1) ? 0.990 : SPARK_DRAG;
    this.vx *= drag;
    this.vy = this.vy * drag + GRAVITY * ((this.kind===1) ? 0.92 : 1.05);

    var t = this.life / this.maxLife;
    if (t >= 1) return false;

    var alpha = 1 - t;
    if (this.twinkle) {
      alpha *= 0.55 + 0.45 * Math.sin(this.seed + this.life*0.38);
      if (alpha < 0) alpha = 0;
      if (alpha > 1) alpha = 1;
    }

    // 关键：控制亮度，避免你截图那种“白一坨”
    if (alpha > 0.92) alpha = 0.92;

    drawPoint(this.x, this.y, this.c, alpha, this.size);
    return true;
  };

  function drawPoint(x,y,c,a,r){
    ctx.beginPath();
    ctx.fillStyle = hslCss(c, a);
    ctx.arc(x, y, r*DPR, 0, Math.PI*2);
    ctx.fill();
  }

  function capSparks(){
    if (sparks.length > MAX_SPARKS) {
      sparks.splice(0, sparks.length - MAX_SPARKS);
    }
  }

  /* ====== 爆炸形态：更“壮观”，但保持原风格 ====== */
  function explode(x,y,baseColor,mode){
    capSparks();

    // 多段：先大团，再内圈，再金雨（层层开花但不泛光）
    if (mode === 3) {
      explodePeony(x,y,baseColor, 1.00);
      setTimeout(function(){
        explodeRing(x,y, (Math.random()<0.5?randomColor():baseColor), 3, 0.55);
      }, 140);
      setTimeout(function(){
        explodeWillow(x,y);
      }, 320);
      if (Math.random() < 0.38) {
        setTimeout(function(){ explodeHeart(x,y); }, 460);
      }
      return;
    }

    if (mode === 2) { explodeHeart(x,y); return; }
    if (mode === 1) { explodeWillow(x,y); return; }

    // 普通：大团 + 偶尔环形内圈，保证“层次”
    explodePeony(x,y,baseColor, 1.0);
    if (Math.random() < 0.20) {
      setTimeout(function(){
        explodeRing(x,y, (Math.random()<0.55?randomColor():baseColor), 2, 0.55);
      }, 140);
    }
  }

  function explodePeony(x,y,baseColor,scale){
    // 更壮观：粒子数明显增加，但单粒子更克制（防泛白）
    var count = (Math.random() < 0.25) ? rand(150, 220) : rand(120, 180);
    count = Math.floor(count * (scale || 1));
    var burst = rand(3.8, 5.8) * (scale || 1);

    for (var i=0;i<count;i++){
      var ang = Math.random()*Math.PI*2;
      var speed = burst * Math.pow(Math.random(), 0.33) * rand(1.0, 1.38);
      var vx = Math.cos(ang)*speed;
      var vy = Math.sin(ang)*speed;

      var c = (Math.random()<0.35)?randomColor():baseColor;
      var size = rand(1.4, 2.3);        // 不要太大，避免“白团”
      var life = rand(55, 90);

      sparks.push(new Spark(x,y,vx,vy,c,size,life,0));
    }
  }

  function explodeRing(x,y,c,rings,scale){
    // 圈层开花（迪士尼感），但仍是“点点拖尾”风格
    var R = rings || 2;
    var sc = scale || 0.6;
    for (var r=1;r<=R;r++){
      var n = 70 + r*38;
      var sp = (2.0 + r*1.0) * sc;
      for (var i=0;i<n;i++){
        var ang = (i/n)*Math.PI*2 + rand(-0.02, 0.02);
        var speed = sp * rand(0.92, 1.12);
        sparks.push(new Spark(x,y,Math.cos(ang)*speed,Math.sin(ang)*speed,c,rand(1.2,2.0),rand(50,80),0));
      }
    }
  }

  function explodeWillow(x,y){
    // 金雨：更铺满天空，但控制亮度
    var gold = { h: rand(42,58), s: rand(88,100), l: rand(52,66) };
    var count = rand(120, 180);
    var burst = rand(2.6, 4.0);
    for (var i=0;i<count;i++){
      var ang = Math.random()*Math.PI*2;
      var speed = burst * Math.pow(Math.random(), 0.25) * rand(0.95, 1.25);
      var vx = Math.cos(ang)*speed;
      var vy = Math.sin(ang)*speed*0.85;
      sparks.push(new Spark(x,y,vx,vy,gold,rand(1.2,2.0),rand(85,130),1));
    }
  }

  function explodeHeart(x,y){
    var heartColor = { h: rand(325,355), s: rand(90,100), l: rand(54,68) };
    var n = 140;             // 心形不要太密，否则叠成白
    var scale = rand(0.15, 0.20);

    for (var i=0;i<n;i++){
      var t = (i/n)*Math.PI*2;
      var hx = 16*Math.pow(Math.sin(t),3);
      var hy = 13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);
      var vx = hx*scale*rand(0.95,1.05);
      var vy = -hy*scale*rand(0.95,1.05);
      sparks.push(new Spark(x,y,vx,vy,heartColor,rand(1.3,2.1),rand(70,110),0));
    }
  }

  /* ====== 发射：更满屏的关键（齐射编排 + 随机补充） ====== */
  function launch(tx, ty, mode){
    var x = rand(W*0.10, W*0.90);
    var y = H - 4;
    if (typeof tx !== 'number') tx = rand(W*0.12, W*0.88);
    if (typeof ty !== 'number') ty = rand(H*0.10, H*0.46);
    rockets.push(new Rocket(x,y,tx,ty,mode||0));
  }

  function fanLaunch(n, centerX, spread, tyMin, tyMax, mode){
    var cx = (typeof centerX==='number') ? centerX : rand(W*0.25, W*0.75);
    var sp = (typeof spread==='number') ? spread : rand(W*0.25, W*0.55);
    var count = n || 6;
    for (var i=0;i<count;i++){
      var t = (count===1) ? 0 : (i/(count-1) - 0.5);
      var tx = cx + t*sp;
      var ty = rand(tyMin || H*0.10, tyMax || H*0.34);
      launch(tx, ty, mode||0);
    }
  }

  /* ====== “更满屏”的编排时间轴（无泛光版本） ====== */
  var cues = [];
  function at(ms, fn){ cues.push({t:ms, fn:fn, done:false}); }

  function buildCues(){
    cues = [];

    // 开场：左右+中间齐射（立刻铺开）
    at(0,    function(){ fanLaunch(7, W*0.50, W*0.85, H*0.14, H*0.36, 3); });
    at(450,  function(){ fanLaunch(5, W*0.25, W*0.55, H*0.12, H*0.30, 0); });
    at(750,  function(){ fanLaunch(5, W*0.75, W*0.55, H*0.12, H*0.30, 0); });

    // 中段：交替多段与金雨，填满上半屏
    at(1400, function(){ fanLaunch(8, W*0.50, W*1.00, H*0.10, H*0.28, 3); });
    at(2000, function(){ fanLaunch(6, W*0.50, W*0.95, H*0.10, H*0.26, 1); });
    at(2550, function(){ fanLaunch(7, W*0.50, W*0.95, H*0.08, H*0.24, 0); });

    // 浪漫段：两侧心形 + 中间多段
    at(3300, function(){ fanLaunch(3, W*0.30, W*0.30, H*0.14, H*0.28, 2); });
    at(3600, function(){ fanLaunch(3, W*0.70, W*0.30, H*0.14, H*0.28, 2); });
    at(3950, function(){ fanLaunch(7, W*0.50, W*0.85, H*0.10, H*0.28, 3); });

    // 终章前：金雨铺满
    at(5200, function(){ fanLaunch(8, W*0.50, W*1.05, H*0.10, H*0.24, 1); });
    at(5800, function(){ fanLaunch(8, W*0.50, W*1.05, H*0.10, H*0.24, 3); });

    // 终章：连续齐射（非常满屏，但控制亮度）
    at(7600, function(){ fanLaunch(10, W*0.50, W*1.20, H*0.08, H*0.22, 3); });
    at(8000, function(){ fanLaunch(10, W*0.50, W*1.20, H*0.08, H*0.22, 1); });
    at(8400, function(){ fanLaunch(10, W*0.50, W*1.20, H*0.08, H*0.22, 3); });
    at(8850, function(){ fanLaunch(7,  W*0.50, W*0.90, H*0.10, H*0.26, 2); });
    at(9300, function(){ fanLaunch(10, W*0.50, W*1.25, H*0.08, H*0.22, 0); });
  }
  buildCues();

  /* ====== 弹幕（修正：不再出现 c\u2764p 字面量，也不再巨大铺满） ====== */
  var danmakuTimer = null;
  function startDanmaku(){
    if (danmakuTimer) return;

    // 先清掉烟花残留，让字更清晰（避免你截图那种糊成一坨）
    ctx.fillStyle = 'rgba(0,0,0,0.55)';
    ctx.fillRect(0,0,W,H);

    // 弹幕大小克制一些
    var baseFont = Math.max(18, Math.min(30, Math.floor(window.innerWidth/18)));
    var lanes = 10;
    var lane = 0;

    function spawnOne(){
      var el = document.createElement('div');
      el.className = 'dm';
      el.textContent = MESSAGE;

      lane = (lane + 1) % lanes;
      var y = Math.floor((lane + 0.5) * (window.innerHeight / lanes)) + Math.floor(rand(-10,10));

      var size = baseFont + rand(-1, 8);
      var hue = rand(330, 360);
      var dur = rand(7.0, 11.0);
      var wobble = rand(-4, 4);

      el.style.top = y + 'px';
      el.style.fontSize = size + 'px';
      el.style.color = 'hsla(' + hue + ',95%,72%,0.94)';

      danmaku.appendChild(el);

      var w = el.getBoundingClientRect().width;
      var totalX = window.innerWidth + w + 160;
      var start = nowMs();

      function tick(tn){
        var t = (tn - start) / (dur*1000);
        if (t >= 1) { if (el && el.parentNode) el.parentNode.removeChild(el); return; }
        var x = -totalX * t;
        var drift = 8 * Math.sin(t*Math.PI*2 + wobble);
        el.style.transform = 'translateX(' + x + 'px) rotate(' + wobble + 'deg) translateY(' + drift + 'px)';
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    // 先一波“结尾弹幕”
    for (var i=0;i<12;i++){
      (function(ii){ setTimeout(function(){ spawnOne(); }, ii*220); })(i);
    }

    // 再持续一小段（不会把屏幕糊满）
    var startAt = nowMs();
    danmakuTimer = setInterval(function(){
      if (nowMs() - startAt > 12000) { clearInterval(danmakuTimer); danmakuTimer = null; return; }
      spawnOne();
    }, 380);
  }

  /* ====== 主循环 ====== */
  var startTime = nowMs();
  var ended = false;

  function reset(){
    rockets.length = 0;
    sparks.length = 0;
    danmaku.innerHTML = '';
    if (danmakuTimer) { clearInterval(danmakuTimer); danmakuTimer = null; }

    for (var i=0;i<cues.length;i++) cues[i].done = false;

    ended = false;
    startTime = nowMs();
    hint.classList.remove('hide');

    ctx.fillStyle = 'rgb(0,0,0)';
    ctx.fillRect(0,0,W,H);

    // 重来开场直接来一波
    fanLaunch(8, W*0.50, W*1.00, H*0.12, H*0.34, 3);
  }

  function frame(){
    // 背景拖尾（保持最开始版本的质感）
    ctx.fillStyle = 'rgba(0,0,0,' + TRAIL_ALPHA + ')';
    ctx.fillRect(0,0,W,H);

    var t = nowMs() - startTime;

    // 时间轴编排
    for (var i=0;i<cues.length;i++){
      if (!cues[i].done && t >= cues[i].t){
        cues[i].done = true;
        cues[i].fn();
      }
    }

    // 随机补充：让屏幕“更满”，但控制模式比例避免白团
    if (!ended && t < SHOW_MS){
      if (Math.random() < AUTO_RATE){
        var r = Math.random();
        var mode = (r < 0.18) ? 3 : (r < 0.32 ? 1 : (r < 0.42 ? 2 : 0));
        launch(null, null, mode);
      }
    }

    // 终章：加密连发（但不加泛光）
    if (!ended && t >= SHOW_MS){
      ended = true;
      hint.classList.add('hide');

      var endStart = nowMs();
      (function finaleLoop(){
        var e = nowMs() - endStart;
        if (e < FINALE_MS){
          // 小扇形快速连发，填满上半屏
          fanLaunch(6, rand(W*0.25, W*0.75), rand(W*0.55, W*0.95), H*0.08, H*0.24, (Math.random()<0.6?3:1));
          setTimeout(finaleLoop, 180);
        } else {
          setTimeout(function(){ startDanmaku(); }, 1100);
        }
      })();
    }

    // 更新火箭/火花
    for (var ri=rockets.length-1; ri>=0; ri--){
      if (!rockets[ri].step()) rockets.splice(ri,1);
    }
    for (var si=sparks.length-1; si>=0; si--){
      if (!sparks[si].step()) sparks.splice(si,1);
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  /* ====== 交互：点击加“豪华齐射”，双击/长按重来 ====== */
  function pointerPos(ev){
    var rect = canvas.getBoundingClientRect();
    return { x:(ev.clientX-rect.left)*DPR, y:(ev.clientY-rect.top)*DPR };
  }

  function clickBurst(x,y){
    // 点击：在点击点附近做一组齐射，立刻更“满屏”
    var ty = clamp(y - rand(160, 260)*DPR, H*0.06, H*0.55);
    fanLaunch(7, x, W*0.75, ty, ty + H*0.10, 3);
  }

  var lastTap = 0;
  window.addEventListener('pointerdown', function(ev){
    hint.classList.add('hide');

    var p = pointerPos(ev);
    clickBurst(p.x, p.y);

    var nt = nowMs();
    if (nt - lastTap < 320) reset(); // 双击重来
    lastTap = nt;
  }, {passive:true});

  var pressTimer = null;
  window.addEventListener('touchstart', function(){
    pressTimer = setTimeout(function(){ reset(); }, 800);
  }, {passive:true});
  window.addEventListener('touchend', function(){
    if (pressTimer) clearTimeout(pressTimer);
    pressTimer = null;
  }, {passive:true});

})();
</script>
</body>
</html>
